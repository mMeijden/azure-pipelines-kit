variables:
  buildConfiguration: Release
  runTests: "true"
  deployToStaging: "false"
  deployToProduction: "false"
  targetPlatform: windows
  isEnterprise: "false"
stages:
  - stage: Build
    jobs:
      - job: BuildWindows
        displayName: Build on Windows
        condition: eq(variables.targetPlatform, 'windows')
        pool: windows-latest
        steps:
          - powershell: |-
              Write-Host "ğŸ”§ Setting up Windows build environment"
              Write-Host "Build Configuration: $(buildConfiguration)"
              $env:DOTNET_CLI_TELEMETRY_OPTOUT = 1
            displayName: Setup Windows Environment
          - powershell: |-
              Write-Host "ğŸ—ï¸ Building application in $(buildConfiguration) mode"
              # dotnet build --configuration $(buildConfiguration)
            displayName: Build Application
          - powershell: |-
              Write-Host "ğŸ§ª Running unit tests"
              # dotnet test --configuration $(buildConfiguration)
            displayName: Run Tests (Conditional)
            condition: eq(variables.runTests, 'true')
      - job: BuildLinux
        displayName: Build on Linux
        condition: eq(variables.targetPlatform, 'linux')
        pool: ubuntu-latest
        steps:
          - bash: |-
              echo "ğŸ”§ Setting up Linux build environment"
              echo "Build Configuration: $(buildConfiguration)"
              export DOTNET_CLI_TELEMETRY_OPTOUT=1
            displayName: Setup Linux Environment
          - bash: |-
              echo "ğŸ—ï¸ Building application on Linux"
              # dotnet build --configuration $(buildConfiguration)
            displayName: Build Application
          - bash: |-
              echo "ğŸ§ª Running Linux-specific tests"
              # dotnet test --configuration $(buildConfiguration)
            displayName: Run Linux Tests (Conditional)
            condition: and(eq(variables.runTests, 'true'), eq(variables.targetPlatform, 'linux'))
  - stage: DeployStaging
    jobs:
      - job: DeployToStaging
        displayName: Deploy to Staging Environment
        dependsOn: Build
        condition: eq(variables.deployToStaging, 'true')
        pool: ubuntu-latest
        steps:
          - bash: |-
              echo "ğŸš€ Deploying to staging environment"
              echo "Target Platform: $(targetPlatform)"

              # This would be conditional in real implementation:
              if [ "$(targetPlatform)" = "windows" ]; then
                echo "ğŸªŸ Deploying Windows application"
              else
                echo "ğŸ§ Deploying Linux application"
              fi
            displayName: Platform-specific Deployment
          - bash: |-
              echo "ğŸ§ª Running smoke tests against staging"
              # curl -f http://staging.myapp.com/health
              echo "âœ… Smoke tests completed"
            displayName: Run Staging Smoke Tests
            condition: eq(variables.runTests, 'true')
  - stage: DeployProduction
    jobs:
      - job: DeployToProduction
        displayName: Deploy to Production Environment
        dependsOn: DeployStaging
        condition: and(eq(variables.deployToProduction, 'true'), succeeded('DeployStaging'))
        pool: ubuntu-latest
        steps:
          - bash: |-
              echo "âœ… Validating production readiness"
              echo "ğŸ” Checking prerequisites..."
            displayName: Pre-deployment Validation
          - bash: |-
              echo "ğŸš€ Starting production deployment"

              # This would use TemplateExpression.if() in real implementation:
              if [ "$(isEnterprise)" = "true" ]; then
                echo "ğŸ”µğŸŸ¢ Performing blue-green deployment for enterprise"
                echo "ğŸ”„ Switching traffic to new deployment..."
              else
                echo "ğŸ“ˆ Performing standard rolling deployment"
                echo "ğŸ“¦ Updating application..."
              fi
            displayName: Enterprise vs Standard Deployment
          - bash: |-
              echo "ğŸ¥ Running production health checks"
              # curl -f https://api.myapp.com/health
              echo "âœ… Production deployment verified!"
            displayName: Post-deployment Health Check
            condition: and(eq(variables.runTests, 'true'), succeeded())
          - bash: |-
              # This would use TemplateExpression.if(succeeded(), ..., ...) in real implementation:
              echo "ğŸ“¢ Sending deployment notification"

              if [ "$AGENT_JOBSTATUS" = "Succeeded" ]; then
                echo "âœ… Deployment successful! Notifying team."
              else
                echo "âŒ Deployment failed! Sending failure notification and rollback instructions."
              fi
            displayName: Deployment Notifications
  - stage: Cleanup
    jobs:
      - job: CleanupResources
        displayName: Cleanup Resources
        dependsOn: DeployProduction
        condition: always()
        pool: ubuntu-latest
        steps:
          - bash: |-
              echo "ğŸ§¹ Performing cleanup operations"

              # This would use TemplateExpression.if() for different cleanup strategies:
              if [ "$AGENT_JOBSTATUS" = "Succeeded" ]; then
                echo "âœ… Pipeline succeeded - performing success cleanup"
                echo "ğŸ“¦ Cleaning up temporary resources"
              else
                echo "âŒ Pipeline failed - performing failure cleanup"
                echo "ğŸ” Preserving logs for investigation"
              fi
            displayName: Conditional Cleanup
